---
title: Analysis of U.S. National Oceanic and Atmospheric Administration's storm
  data
author: "Emmanuel ROCHE"
date: "08/03/2016"
output: html_document
---

# Synopsys

# Data Processing

The source dataset used in this analysis can be retrieved from , we keep the dataset in a compressed format since it can be read directly in R.

```{r cache=TRUE}
if(!file.exists("StormData.csv.bz2"))
{
  download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", destfile = "StormData.csv.bz2")
}

data <- read.csv("StormData.csv.bz2")
```

We can first check the number of observations available:

```{r}
dim(data)

```

This dataset contains `r dim(data[2])` variables, but for this initial analysis, we are only interested in a few of those variables, that will be selected below depending on the focus of the analysis (either population health impact or economic impact)

## Population health impact processing

For this part of the analysis, we will focus on the following variables:

  * **EVTTYPE** : indicates the type of the storm event that occured,
  * **FATALITIES** : number of death due to the storm event,
  * **INJURIES** : number of injuries due to the storm event.

We isolate those variables in a new dataset, and we only consider the available complete cases. It is also worth noticing that some of event types are very similar, so we try to merge them as mush as possible by applying a few transformation rules in the following order:

  1. We will remove all ".",
  1. We will remove all ending "/" characters in the event type names,
  1. We will replace "XXX/YYY" with "XXX AND YYY",
  1. We will replace "XXX & YYY" with "XXX AND YYY",
  1. We will turn all event type names to lower case.
  

```{r results='hide'}
library(dplyr)
health_dat <- select(data,EVTYPE,FATALITIES,INJURIES)
health_dat <- health_dat[complete.cases(health_dat),]

# Applying the transformations rules for the event types:
health_dat$EVTYPE <- gsub("\\.","",health_dat$EVTYPE)
health_dat$EVTYPE <- gsub("/$","",health_dat$EVTYPE)
health_dat$EVTYPE <- gsub("/"," AND ",health_dat$EVTYPE)
health_dat$EVTYPE <- gsub(" & "," AND ",health_dat$EVTYPE)
health_dat$EVTYPE <- tolower(health_dat$EVTYPE)
```


## Economic impact processing

For the economic perspective, we will focus on the following variables:

  * **EVTTYPE** : indicates the type of the storm event that occured,
  * **PROPDMG**: property damage due to the storm event,
  * **CROPDMG**: crop damage due to the storm event.
  
```{r}
library(dplyr)
eco_dat <- select(data,EVTYPE,PROPDMG,CROPDMG)

# Again we only keep the complete cases:
eco_dat <- eco_dat[complete.cases(eco_dat),]
```

As with the population health processing, we also need to clean the EVTYPE values for this second part of the analysis:

```{r}
# Applying the transformations rules for the event types:
eco_dat$EVTYPE <- gsub("\\.","",eco_dat$EVTYPE)
eco_dat$EVTYPE <- gsub("/$","",eco_dat$EVTYPE)
eco_dat$EVTYPE <- gsub("/"," AND ",eco_dat$EVTYPE)
eco_dat$EVTYPE <- gsub(" & "," AND ",eco_dat$EVTYPE)
eco_dat$EVTYPE <- tolower(eco_dat$EVTYPE)
```

# Results

## Storm events population health impact

To clarify what is the population health impact of the storm events, we first summarize the fatalities and injuries per event type:

```{r results='hide'}
library(plyr)
health_impact <- ddply(health_dat, "EVTYPE", summarize, total_death=sum(FATALITIES), total_injuries=sum(INJURIES))
```

From this health_impact dataset, we can extract the event types producing the highest number of fatalities and injuries. But  first, to simplify the analysis, we can turn the total number of death and injuries into percentages:

```{r}
tot_death <- sum(health_impact$total_death)
tot_inj <- sum(health_impact$total_injuries)

health_impact <- mutate(health_impact, total_death = 100.0*total_death/tot_death, total_injuries = 100.0*total_injuries/tot_inj) 

# select the highest fatalities values:
highest_death <- health_impact[order(health_impact$total_death, decreasing=T),]
highest_inj <- health_impact[order(health_impact$total_injuries, decreasing=T),]
```

Also note here that those storm event were responsible so far for at least `r format(tot_death,scientific=F)` deaths and `r format(tot_inj,scientific=F)` injuries according to this report.

Now to get an idea on the most harmfull type of storm event we will mainly consider those responsible for 80% of the fatalities and injuries respectively:

```{r}
# Accumulate the percentage of death and injuries:
highest_death <- mutate(highest_death,accum_death=cumsum(total_death))
highest_inj <- mutate(highest_inj,accum_injuries=cumsum(total_injuries))

focus_death <- highest_death[highest_death$accum_death<80.0,]
focus_inj <- highest_inj[highest_inj$accum_injuries<80.0,]

# Compute the number of event types of interest:
nfdeath <- dim(focus_death)[1]
nfinj <- dim(focus_inj)[1]
```


Finally we can plot here the distribution of the `r format(nfdeath)` most deadly storm event types and the `r format(nfinj)` types responsible for about 80% of the injuries:

```{r}
library(ggplot2)
library(gridExtra)

p<-ggplot(focus_death, aes(x=1:nfdeath, y=total_death, fill=EVTYPE)) + geom_bar(stat="identity")+theme_minimal()
p<-p+labs(title="Most harmfull storm events\nFatalities", x="Event type", y = "Percentage of death")
p<-p+geom_text(aes(label=sprintf("%.2f%%",total_death)), vjust=0.0, size=2.5, angle=45, hjust=0.0)
p<-p+theme(legend.justification=c(1,1), legend.position=c(1,1), axis.text.x=element_blank())
p<-p+scale_y_continuous(limits = c(0.0,100.0))

p2<-ggplot(focus_inj, aes(x=1:nfinj, y=total_injuries, fill=EVTYPE)) + geom_bar(stat="identity")+theme_minimal()
p2<-p2+labs(title="Most harmfull storm events\nInjuries", x="Event type", y = "Percentage of injuries")
p2<-p2+geom_text(aes(label=sprintf("%.2f%%",total_injuries)), vjust=-0.3, size=2.5)
p2<-p2+theme(legend.justification=c(1,1), legend.position=c(1,1), axis.text.x=element_blank())
p2<-p2+scale_y_continuous(limits = c(0.0,100.0))

grid.arrange(p,p2,ncol=2)

```

As represented on the graphics above it seems that tornados are the absolute most harmfull storm events during the period covered by the source dataset. The fatalities impact is then more distributed on about 10 event types, whereas, for the injuries, we can select only 4 event types responsible for most injury cases (80%).

## Storm events economic impact

We start here with summarizing the property and crop damage per event type:

```{r}
library(plyr)
eco_impact <- ddply(eco_dat, "EVTYPE", summarize, prop_damage=sum(PROPDMG), crop_damage=sum(CROPDMG))

eco_nevents <- dim(eco_impact)[1]
```

We now have to select the most harmfull event types amongt the `r sprintf("%d",eco_nevents)` unique event types found. To acheive this we can proceed as with the population health analysis: we turn the numbers of interest into percentages, and we select the event types responsible for about 80% of the damage costs.

But this time, we will summarise the input data one step further, and assume that property damages and crop damages have equivalent economic impact, so we can sum them together first.

```{r}
# compute the total damages:
eco_impact$total_damage <- eco_impact$prop_damage + eco_impact$crop_damage

# compute the overall total damage value:
tot_dmgvalue <- sum(eco_impact$total_damage)

# turn the total damage into percentages:
eco_impact$total_damage <- 100.0*eco_impact$total_damage/tot_dmgvalue

# order the entries by total damage percentage values, and only keep the EVTYPE 
# and the total_damage columns in this process:
eco_impact <- eco_impact[order(eco_impact$total_damage, decreasing = T),c("EVTYPE","total_damage")]

# Now add the cumulative damage percentage column:
eco_impact <- mutate(eco_impact, accum_damage = cumsum(total_damage))

# Lets print the 20 first entries:
head(eco_impact,10)
```

We can now produce a plot presenting the event types responsible for about 80% of the damage costs.

```{r}
# keep only the most damaging event types:
eco_focus <- eco_impact[eco_impact$accum_damage<80.0,]

# keep number of focused event types:
eco_nevents <- dim(eco_focus)[1]

# Generate the bar plot:
library(ggplot2)

p<-ggplot(eco_focus, aes(x=1:eco_nevents, y=total_damage, fill=EVTYPE)) + geom_bar(stat="identity")+theme_minimal()
p<-p+labs(title="Most harmfull storm events\nDamage costs", x="Event type", y = "Percentage of all costs")
p<-p+geom_text(aes(label=sprintf("%.2f%%",total_damage)), vjust=-0.3, size=2.5, angle=0, hjust=0.5)
p<-p+theme(legend.justification=c(1,1), legend.position=c(1,1), axis.text.x=element_blank())
p<-p+scale_y_continuous(limits = c(0.0,100.0))

p
```

We observe from the previous graph that `r sprintf("%d", eco_nevents)`event types are responsible for about 80% of the damage costs. Among those listed storm events we can notice once more that the Tornados are the most harmfull event type, accounting on its own for about `r sprintf("%.0f%%",eco_focus$total_damage[1])` of the overall damage cost.




